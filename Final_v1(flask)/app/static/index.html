<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta and Title -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShadowByte - Suspect Visualization</title>
    <!-- External Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet" />
    <!-- Styles -->
    <link rel="stylesheet" href="css/main.css">
    <!-- Firebase SDKs (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
      <!-- Firebase Initialization -->
      <script>
        // Your Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyDZx8uWNQUVx6uuW2834DCMSnVD4yAsM2Q",
            authDomain: "shadowbyte-c0b66.firebaseapp.com",
            projectId: "shadowbyte-c0b66",
            storageBucket: "shadowbyte-c0b66.appspot.com",
            messagingSenderId: "837344026144",
            appId: "1:837344026144:web:2a2b67a9090eafcd8ea645",
            measurementId: "G-QTGZHNPB9P"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var auth = firebase.auth();
        var db = firebase.firestore();
    </script>
</head>
<body>
    <div class="container">
        <!-- Sidebar (Left Side) -->
        <div class="sidebar">
            <h1><i class="fas fa-user-secret"></i> ShadowByte</h1>
            <div class="section overview-frame">
                <h2>Overall Details</h2>
                <p>Total Suspects: <span id="total-suspects">0</span></p>
                <p>Total Connections: <span id="total-connections">0</span></p>
            </div>
            <!-- New Suspects List Section -->
            <div class="section suspects-list">
                <h2><i class="fas fa-list"></i> Suspects List</h2>
                <div class="suspects-container" id="suspects-container">
                    <!-- Suspect items will be dynamically populated here -->
                </div>
            </div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <input id="search" placeholder="Search in the graph..." type="text" />
                <div class="header-right">
                    <div class="buttons">
                        <button id="add-node"><i class="fas fa-plus"></i> Add Suspect</button>
                        <button id="delete-node"><i class="fas fa-trash"></i> Delete Suspect</button>
                    </div>
                </div>
            </div>
            <div class="graph">
                <div id="cy"></div>
            </div>
            <div class="footer">
                <a href="#"><i class="fas fa-server"></i> API requests: <span id="api-requests">0</span></a>
                <div>
                    <a href="documenttaion.html"><i class="fas fa-book"></i> Documentation</a>
                </div>
            </div>
        </div>

        <!-- Profile Icon -->
        <i class="fas fa-user-circle profile-icon" id="profile-icon"></i>
        <!-- Tool Panel (Right Side) -->
        <div class="tool-panel">
            <!-- Tool panel content -->
            <div class="category">
                <h2><i class="fas fa-tools"></i> Tools</h2>
                <div class="tool-list">
                    <button id="add-connection"><i class="fas fa-link"></i> Add Connection</button>
                    <button id="analyze-network"><i class="fas fa-search"></i> Analyze Network</button>
                    <button id="export-data"><i class="fas fa-file-export"></i> Export Data</button>
                    <button id="import-data"><i class="fas fa-file-import"></i> Import Data</button>
                    <button id="settings"><i class="fas fa-cog"></i> Settings</button>
                </div>
            </div>
            <div class="category">
                <h2><i class="fas fa-database"></i> Data Collection</h2>
                <div class="tool-list">
                    <button id="web-scraping"><i class="fas fa-globe"></i> Web Scraping</button>
                    <button id="api-integration"><i class="fas fa-plug"></i> API Integration</button>
                    <button id="social-media-scraping"><i class="fas fa-hashtag"></i> Social Media Scraping</button>
                    <button id="dork-suspect"><i class="fas fa-magnifying-glass"></i> Dork Suspect</button>
                    <!-- New Instagram Scraping Button -->
                    <button id="instagram-scraping"><i class="fab fa-instagram"></i> Instagram Scraping</button>
                </div>
            </div>
            <div class="category">
                <h2><i class="fas fa-chart-bar"></i> Analytics</h2>
                <div class="tool-list">
                    <button id="generate-reports"><i class="fas fa-file-alt"></i> Generate Reports</button>
                    <button id="statistics"><i class="fas fa-chart-pie"></i> Statistics</button>
                    <button id="trend-analysis"><i class="fas fa-chart-line"></i> Trend Analysis</button>
                </div>
            </div>
            <div class="category">
                <h2><i class="fas fa-user-shield"></i> Security</h2>
                <div class="tool-list">
                    <button id="user-management"><i class="fas fa-users-cog"></i> User Management</button>
                    <button id="access-control"><i class="fas fa-shield-alt"></i> Access Control</button>
                    <button id="audit-logs"><i class="fas fa-clipboard-list"></i> Audit Logs</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modals -->
    <!-- Modal for Adding Node -->
    <div id="node-modal" class="modal">
        <div class="modal-content">
            <h2>Add Suspect</h2>
            <form id="node-form">
                <!-- Removed Suspect ID field -->
                <label for="full-name">Full Name:</label>
                <input type="text" id="full-name" name="full-name" required />
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" />
                <label for="nic">NIC:</label>
                <input type="text" id="nic" name="nic" />
                <label for="social-media">Social Media Accounts:</label>
                <input type="text" id="social-media" name="social-media" placeholder="Comma-separated usernames" />
                <div class="buttons">
                    <button type="button" class="cancel" id="node-cancel-button">Cancel</button>
                    <button type="submit" class="submit">Add Suspect</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal for Node Details -->
    <div id="detail-modal" class="detail-modal">
        <div class="detail-modal-content">
            <h2>Node Details</h2>
            <!-- Suspect Details -->
            <div id="suspect-details">
                <p><span>ID:</span> <span id="detail-id"></span></p>
                <p><span>Full Name:</span> <span id="detail-fullname"></span></p>
                <p><span>Email:</span> <span id="detail-email"></span></p>
                <p><span>NIC:</span> <span id="detail-nic"></span></p>
                <p><span>Social Media:</span> <span id="detail-socialmedia"></span></p>
            </div>
            <!-- Result Details -->
            <div id="result-details" style="display: none;">
                <p><span>Title:</span> <span id="detail-title"></span></p>
                <p><span>Link:</span> <a href="#" id="detail-link" target="_blank">View Link</a></p>
                <p><span>Snippet:</span> <span id="detail-snippet"></span></p>
                <p><span>Category:</span> <span id="detail-category"></span></p>
                <!-- Image Preview for Google Images -->
                <div id="image-preview" style="display: none;">
                    <img id="preview-image-full" src="" alt="Image Preview" />
                </div>
            </div>
            <!-- Instagram Details -->
            <div id="instagram-details" style="display: none;">
                <p><span>Username:</span> <span id="detail-username"></span></p>
                <p><span>Profile URL:</span> <a href="#" id="detail-profile-url" target="_blank">View Profile</a></p>
            </div>
            <div class="close-btn">
                <button id="close-detail-modal">Close</button>
            </div>
        </div>
    </div>
    <!-- Image Preview Modal -->
    <div id="image-preview-modal" class="modal">
        <div class="modal-content" id="image-preview-content">
            <h2>Image Preview</h2>
            <img id="preview-image-full" src="" alt="Image Preview" />
            <div class="close-btn">
                <button id="close-image-preview">Close</button>
            </div>
        </div>
    </div>
    <!-- Account Modal -->
    <div id="account-modal" class="account-modal">
        <div class="account-modal-content">
            <h2>Account Details</h2>
            <p><strong>Username:</strong> <span id="account-username">Loading...</span></p>
            <p><strong>Email:</strong> <span id="account-email">Loading...</span></p>
            <!-- Add more account details as needed -->
            <button id="logout-button-modal">Logout</button>
        </div>
    </div>

    <!-- Modal for Dork Suspect Options -->
    <div id="dork-modal" class="modal">
        <div class="modal-content">
            <h2>Dork Suspect</h2>
            <form id="dork-form">
                <label for="search-all">Search All Name Types:</label>
                <select id="search-all" name="search-all" required>
                    <option value="">Select</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
                <label>Select Search Engines:</label>
                <div class="tool-list">
                    <div>
                        <input type="checkbox" id="google" name="search-engines" value="google">
                        <label for="google">Google</label>
                    </div>
                    <div>
                        <input type="checkbox" id="bing" name="search-engines" value="bing">
                        <label for="bing">Bing</label>
                    </div>
                </div>
                <div class="buttons">
                    <button type="button" class="cancel" id="dork-cancel-button">Cancel</button>
                    <button type="submit" class="submit">Start Dorking</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal for Existing Suspect -->
    <div id="existing-suspect-modal" class="modal">
        <div class="modal-content">
            <h2>Suspect Already Exists</h2>
            <p>The suspect "<span id="existing-suspect-name"></span>" has already been scraped.</p>
            <p>Do you want to use existing data or scrape again?</p>
            <div class="buttons">
                <button id="use-existing">Use Existing Data</button>
                <button id="scrape-again">Scrape Again</button>
            </div>
        </div>
    </div>
    <!-- Modal for Instagram Scraping -->
    <div id="instagram-modal" class="modal">
        <div class="modal-content">
            <h2>Instagram Scraping</h2>
            <p>Please select a suspect to perform Instagram scraping.</p>
            <div class="buttons">
                <button type="button" class="cancel" id="instagram-cancel-button">Cancel</button>
                <button type="button" class="submit" id="instagram-confirm-button">Start Scraping</button>
            </div>
        </div>
    </div>
    <!-- Polling Message -->
    <div id="polling-message" style="display: none; color: #fff; text-align: center; padding: 10px; background-color: rgba(0, 0, 0, 0.5); position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1003;">
        Scraping in progress...
    </div>

    <div id="context-menu">
        <ul>
            <li id="context-dorking">Investigate</li>
            <li id="context-delete">Delete Node</li>
        </ul>
    </div>

    <script>
        var existingSuspectName = '';
        var existingSuspectId = '';
        var dorkingSuspect = null;
        var selectedSuspect = null;
        var apiRequestCount = 0;

        document.querySelectorAll('.tool-panel .category h2').forEach(header => {
            header.addEventListener('click', () => {
                const toolList = header.nextElementSibling;
                toolList.style.display = toolList.style.display === 'block' ? 'none' : 'block';
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            var cy = cytoscape({
                container: document.getElementById('cy'),
                style: [
                    {
                        selector: 'node[type="method"]',
                        style: {
                            'background-color': '#ff5722',
                            'shape': 'ellipse',
                            'label': 'data(label)',
                            'font-size': '14px',
                            'color': '#fff',
                            'text-valign': 'center',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="domain"]',
                        style: {
                            'background-color': '#2196f3',
                            'shape': 'rectangle',
                            'label': 'data(label)',
                            'font-size': '12px',
                            'color': '#fff',
                            'text-valign': 'center',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"]',
                        style: {
                            'background-color': '#4caf50',
                            'shape': 'diamond',
                            'label': 'data(label)',
                            'font-size': '10px',
                            'color': '#fff',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="instagram"]',
                        style: {
                            'background-color': '#E1306C',
                            'shape': 'roundrectangle',
                            'label': 'data(label)',
                            'font-size': '12px',
                            'color': '#fff',
                            'text-valign': 'center',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'edge[type="method-connection"]',
                        style: {
                            'line-color': '#ff5722',
                            'target-arrow-color': '#ff5722',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: 'edge[type="domain-connection"]',
                        style: {
                            'line-color': '#2196f3',
                            'target-arrow-color': '#2196f3',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: 'edge[type="result-connection"]',
                        style: {
                            'line-color': '#4caf50',
                            'target-arrow-color': '#4caf50',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: 'edge[type="instagram-connection"]',
                        style: {
                            'line-color': '#E1306C',
                            'target-arrow-color': '#E1306C',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: 'node[type="suspect"]',
                        style: {
                            'width': '50px',
                            'height': '50px',
                            'background-color': '#555',
                            'shape': 'ellipse',
                            'border-color': '#000',
                            'border-width': 3,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '12px',
                            'text-valign': 'center',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="source"]',
                        style: {
                            'width': '60px',
                            'height': '60px',
                            'background-color': '#007bff',
                            'shape': 'rectangle',
                            'border-color': '#000',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '14px',
                            'text-valign': 'center',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"][category="google_web_pages"]',
                        style: {
                            'background-color': '#1f77b4',
                            'shape': 'ellipse',
                            'border-color': '#333',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '10px',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"][category="google_images"]',
                        style: {
                            'background-color': '#ff7f0e',
                            'shape': 'rectangle',
                            'border-color': '#333',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '10px',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"][category="google_documents"]',
                        style: {
                            'background-color': '#2ca02c',
                            'shape': 'diamond',
                            'border-color': '#333',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '10px',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"][category="bing_web_pages"]',
                        style: {
                            'background-color': '#d62728',
                            'shape': 'triangle',
                            'border-color': '#333',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '10px',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"]',
                        style: {
                            'background-color': '#9467bd',
                            'shape': 'hexagon',
                            'border-color': '#333',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '10px',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#ccc',
                            'target-arrow-color': '#ccc',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: ':selected',
                        style: {
                            'background-color': '#ffa500',
                            'line-color': '#ffa500',
                            'target-arrow-color': '#ffa500',
                            'source-arrow-color': '#ffa500',
                            'border-width': 2,
                            'border-color': '#ffffff'
                        }
                    },
                    {
                        selector: '.highlighted',
                        style: {
                            'background-color': '#FFD700', // Gold color for highlighting
                            'border-color': '#000',
                            'border-width': 4,
                            'z-index': 10,
                            'overlay-opacity': 0
                        }
                    }
                ],
                elements: [],
                layout: {
                    name: 'cose',
                    padding: 10
                }
            });

            // Debounce function to limit the rate of search execution
            function debounce(func, delay) {
                let debounceTimer;
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func.apply(context, args), delay);
                };
            }

            // Enhanced Search Function Implementation
            const searchInput = document.getElementById('search');

            searchInput.addEventListener('input', debounce(function() {
                const query = this.value.trim().toLowerCase();

                // Reset all nodes to default style by removing 'highlighted' class
                cy.nodes().removeClass('highlighted');

                if (query === '') return;

                // Find matching nodes across multiple fields
                const matchingNodes = cy.nodes().filter(node => {
                    const label = node.data('label') || '';
                    const email = node.data('email') || '';
                    const nic = node.data('nic') || '';
                    const socialMedia = node.data('socialMedia') || '';
                    return label.toLowerCase().includes(query) ||
                           email.toLowerCase().includes(query) ||
                           nic.toLowerCase().includes(query) ||
                           socialMedia.toLowerCase().includes(query);
                });

                // Highlight matching nodes
                matchingNodes.addClass('highlighted');

                // Optionally, fit the view to the matching nodes
                if (matchingNodes.length > 0) {
                    cy.fit(matchingNodes, 50);
                }
            }, 300)); // 300ms debounce delay

            // Existing JavaScript code continues here...

            // Example: Handling Add Node Modal
            var addModal = document.getElementById('node-modal');
            var form = document.getElementById('node-form');
            var nodeCancelBtn = document.getElementById('node-cancel-button');

            var contextMenu = document.getElementById('context-menu');
            var contextDorking = document.getElementById('context-dorking');
            var contextDelete = document.getElementById('context-delete');

            // Open modal on 'Add Node' click
            document.getElementById('add-node').addEventListener('click', function() {
                addModal.style.display = 'block';
            });

            // Close node modal on 'Cancel' click
            nodeCancelBtn.addEventListener('click', function() {
                addModal.style.display = 'none';
                form.reset();
            });

            // Handle form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                var fullName = document.getElementById('full-name').value.trim();
                var email = document.getElementById('email').value.trim();
                var nic = document.getElementById('nic').value.trim();
                var socialMedia = document.getElementById('social-media').value.trim();

                var suspectData = {
                    suspect_name: fullName,
                    email: email,
                    nic: nic,
                    social_media: socialMedia
                };

                fetch('/api/add-suspect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(suspectData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        apiRequestCount += 1;
                        document.getElementById('api-requests').innerText = apiRequestCount;

                        cy.add({
                            group: 'nodes',
                            data: {
                                id: data.suspect_id,
                                label: fullName,
                                email: email || '',
                                nic: nic || '',
                                socialMedia: socialMedia || '',
                                type: 'suspect'
                            }
                        });

                        cy.layout({ name: 'cose', padding: 10, animate: true }).run();

                        updateCounts();
                        updateSuspectsList();
                    } else if (data.status === 'exists') {
                        existingSuspectId = data.suspect_id;
                        existingSuspectName = fullName;
                        openExistingSuspectModal(data.suspect_id, fullName);
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while adding the suspect.');
                });

                addModal.style.display = 'none';
                form.reset();
            });

            // Delete node functionality
            document.getElementById('delete-node').addEventListener('click', function() {
                var selectedNodes = cy.$(':selected');
                if (selectedNodes.length > 0) {
                    if (confirm('Are you sure you want to delete the selected suspect(s) and all their connections?')) {
                        selectedNodes.forEach(node => {
                            var suspectId = node.id();
                            fetch('/api/delete-suspect', {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ suspect_id: suspectId })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    console.log(`Deleted suspect ID: ${suspectId}`);
                                } else {
                                    console.error(`Error deleting suspect: ${data.error}`);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });

                            cy.remove(node);
                        });

                        updateCounts();
                        updateSuspectsList();
                    }
                } else {
                    alert('Please select a suspect to delete.');
                }
            });

            // Suspect detail modal elements
            var detailModal = document.getElementById('detail-modal');
            var closeDetailBtn = document.getElementById('close-detail-modal');

            // Image preview modal elements
            var imagePreviewModal = document.getElementById('image-preview-modal');
            var closeImagePreviewBtn = document.getElementById('close-image-preview');

            // Node selection and detail display
            cy.on('tap', 'node', function(evt){
                var node = evt.target;
                cy.$('node').unselect();
                node.select();

                var type = node.data('type');

                if(type === 'suspect') {
                    selectedSuspect = node.data();

                    document.getElementById('suspect-details').style.display = 'block';
                    document.getElementById('result-details').style.display = 'none';
                    document.getElementById('instagram-details').style.display = 'none';

                    document.getElementById('detail-id').innerText = node.data('id') || 'N/A';
                    document.getElementById('detail-fullname').innerText = node.data('label') || 'N/A';
                    document.getElementById('detail-email').innerText = node.data('email') || 'N/A';
                    document.getElementById('detail-nic').innerText = node.data('nic') || 'N/A';
                    document.getElementById('detail-socialmedia').innerText = node.data('socialMedia') || 'N/A';
                }
                else if(type === 'source') {
                    document.getElementById('suspect-details').style.display = 'none';
                    document.getElementById('result-details').style.display = 'block';
                    document.getElementById('instagram-details').style.display = 'none';

                    document.getElementById('detail-title').innerText = node.data('label') || 'Source';
                    var linkElement = document.getElementById('detail-link');
                    linkElement.href = '#';
                    linkElement.innerText = 'N/A';
                    document.getElementById('detail-snippet').innerText = '';
                    document.getElementById('detail-category').innerText = node.data('category') || 'N/A';
                    document.getElementById('image-preview').style.display = 'none';
                }
                else if(type === 'result') {
                    document.getElementById('suspect-details').style.display = 'none';
                    document.getElementById('result-details').style.display = 'block';
                    document.getElementById('instagram-details').style.display = 'none';

                    document.getElementById('detail-title').innerText = node.data('label') || 'N/A';
                    var linkElement = document.getElementById('detail-link');
                    linkElement.href = node.data('link') || '#';
                    linkElement.innerText = node.data('link') ? 'View Link' : 'N/A';
                    document.getElementById('detail-snippet').innerText = node.data('snippet') || 'N/A';
                    document.getElementById('detail-category').innerText = node.data('category') || 'N/A';

                    if(node.data('category') === 'google_images' && node.data('image_url')) {
                        document.getElementById('preview-image-full').src = node.data('image_url');
                        imagePreviewModal.style.display = 'block';
                    } else {
                        document.getElementById('image-preview').style.display = 'none';
                    }
                }
                else if(type === 'instagram') {
                    document.getElementById('suspect-details').style.display = 'none';
                    document.getElementById('result-details').style.display = 'none';
                    document.getElementById('instagram-details').style.display = 'block';

                    document.getElementById('detail-username').innerText = node.data('username') || 'N/A';
                    var profileUrlElement = document.getElementById('detail-profile-url');
                    profileUrlElement.href = node.data('profile_url') || '#';
                    profileUrlElement.innerText = 'View Profile';
                }

                detailModal.style.display = 'block';
            });

            // Add event listener for the 'Dork Suspect' button
            document.getElementById('dork-suspect').addEventListener('click', function() {
                if (!selectedSuspect || !selectedSuspect.id) {
                    alert('Please select a suspect to perform dorking.');
                    return;
                }
                dorkingSuspect = selectedSuspect;
                dorkModal.style.display = 'block';
            });

            // Close detail modal
            closeDetailBtn.addEventListener('click', function() {
                detailModal.style.display = 'none';
                document.getElementById('image-preview').style.display = 'none';
            });

            // Close image preview modal
            closeImagePreviewBtn.addEventListener('click', function() {
                imagePreviewModal.style.display = 'none';
            });

            // Right-click context menu
            cy.on('cxttap', 'node', function(evt){
                var node = evt.target;
                var evtPos = evt.renderedPosition;
                contextMenu.style.display = 'block';
                contextMenu.style.left = evt.originalEvent.pageX + 'px';
                contextMenu.style.top = evt.originalEvent.pageY + 'px';
                contextMenu.currentNode = node;
            });

            // Handle context menu actions
            contextDorking.addEventListener('click', function() {
                var node = contextMenu.currentNode;
                if(node && node.data('type') === 'suspect') {
                    dorkingSuspect = node.data();
                    dorkModal.style.display = 'block';
                }
                contextMenu.style.display = 'none';
            });

            contextDelete.addEventListener('click', function() {
                var node = contextMenu.currentNode;
                if(node) {
                    if (confirm('Are you sure you want to delete this node and its connections?')) {
                        var suspectId = node.id();
                        fetch('/api/delete-suspect', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ suspect_id: suspectId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                cy.remove(node);
                                updateCounts();
                                updateSuspectsList();
                            } else {
                                alert(`Error: ${data.error}`);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while deleting the suspect.');
                        });
                    }
                }
                contextMenu.style.display = 'none';
            });

            // Close context menu on click elsewhere
            document.addEventListener('click', function(e) {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.style.display = 'none';
                }
            });

            // Modal elements for Dork Suspect
            var dorkModal = document.getElementById('dork-modal');
            var dorkForm = document.getElementById('dork-form');
            var dorkCancelBtn = document.getElementById('dork-cancel-button');

            // Handle Dork Suspect form submission
            dorkForm.addEventListener('submit', function(e) {
                e.preventDefault();

                var searchAll = document.getElementById('search-all').value;
                var searchEngines = [];
                if (document.getElementById('google').checked) {
                    searchEngines.push('google');
                }
                if (document.getElementById('bing').checked) {
                    searchEngines.push('bing');
                }

                if (searchEngines.length === 0) {
                    alert('Please select at least one search engine.');
                    return;
                }

                if (!dorkingSuspect) {
                    alert('No suspect selected for dorking.');
                    return;
                }

                var dorkData = {
                    suspect_id: dorkingSuspect.id,
                    search_all: searchAll === 'yes',
                    search_engines: searchEngines
                };

                fetch('/api/dork-suspect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dorkData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Dorking initiated for ${dorkingSuspect.label}.`);
                        apiRequestCount += 1;
                        document.getElementById('api-requests').innerText = apiRequestCount;

                        pollForResults(dorkingSuspect.id, dorkingSuspect.label);
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while initiating dorking.');
                });

                dorkModal.style.display = 'none';
                dorkForm.reset();
            });

            // Close Dork Modal on 'Cancel'
            dorkCancelBtn.addEventListener('click', function() {
                dorkModal.style.display = 'none';
                dorkForm.reset();
            });

            // Modal elements for Instagram Scraping
            var instagramModal = document.getElementById('instagram-modal');
            var instagramCancelBtn = document.getElementById('instagram-cancel-button');
            var instagramConfirmBtn = document.getElementById('instagram-confirm-button');

            // Open Instagram Scraping Modal
            document.getElementById('instagram-scraping').addEventListener('click', function() {
                if (!selectedSuspect || !selectedSuspect.id) {
                    alert('Please select a suspect to perform Instagram scraping.');
                    return;
                }
                instagramModal.style.display = 'block';
            });

            // Handle Instagram Scraping Confirmation
            instagramConfirmBtn.addEventListener('click', function() {
                if (!selectedSuspect || !selectedSuspect.id) {
                    alert('Please select a suspect to perform Instagram scraping.');
                    instagramModal.style.display = 'none';
                    return;
                }

                var suspectId = selectedSuspect.id;

                fetch('/api/instagram-scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ suspect_id: suspectId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Instagram scraping completed successfully.');
                        processInstagramResults(data.data, suspectId);
                        apiRequestCount += 1;
                        document.getElementById('api-requests').innerText = apiRequestCount;
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while performing Instagram scraping.');
                });

                instagramModal.style.display = 'none';
            });

            // Close Instagram Modal on 'Cancel'
            instagramCancelBtn.addEventListener('click', function() {
                instagramModal.style.display = 'none';
            });

            // Function to process Instagram results and update the graph
            function processInstagramResults(results, suspectId) {
                if (!results || results.length === 0) {
                    alert('No Instagram accounts found.');
                    return;
                }

                let newNodes = [];
                let newEdges = [];

                results.forEach(item => {
                    const instaNodeId = `instagram-${item.username}`;
                    if (cy.getElementById(instaNodeId).length === 0) {
                        newNodes.push({
                            group: 'nodes',
                            data: {
                                id: instaNodeId,
                                label: item.username,
                                username: item.username,
                                profile_url: item.link,
                                type: 'instagram'
                            }
                        });

                        newEdges.push({
                            group: 'edges',
                            data: {
                                source: suspectId,
                                target: instaNodeId,
                                type: 'instagram-connection'
                            }
                        });
                    }
                });

                if (newNodes.length > 0) {
                    cy.add(newNodes);
                    console.log(`Added ${newNodes.length} new Instagram nodes.`);
                }

                if (newEdges.length > 0) {
                    cy.add(newEdges);
                    console.log(`Added ${newEdges.length} new Instagram edges.`);
                }

                cy.layout({ name: 'cose', padding: 10, animate: true }).run();

                updateCounts();
                updateSuspectsList();
            }

            // Modal for Existing Suspect
            var existingSuspectModal = document.getElementById('existing-suspect-modal');
            var useExistingBtn = document.getElementById('use-existing');
            var scrapeAgainBtn = document.getElementById('scrape-again');

            function openExistingSuspectModal(suspect_id, suspect_name) {
                existingSuspectModal.style.display = 'block';
                document.getElementById('existing-suspect-name').innerText = suspect_name;
                existingSuspectId = suspect_id;
            }

            useExistingBtn.addEventListener('click', function() {
                existingSuspectModal.style.display = 'none';
                fetch(`/api/get-results?suspect_id=${encodeURIComponent(existingSuspectId)}`)
                .then(response => response.json())
                .then(resultsData => {
                    if (resultsData.status === 'success') {
                        processResultsData(resultsData.data, existingSuspectId, existingSuspectName);
                        alert(`Loaded existing data for ${existingSuspectName}.`);
                        updateCounts();
                        updateSuspectsList();
                    } else {
                        alert(`Error: ${resultsData.error || 'No existing data found.'}`);
                    }
                })
                .catch(error => {
                    console.error('Error fetching existing data:', error);
                    alert('An error occurred while fetching existing data.');
                });
            });

            scrapeAgainBtn.addEventListener('click', function() {
                existingSuspectModal.style.display = 'none';
                fetch('/api/dork-suspect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        suspect_id: existingSuspectId,
                        search_all: true,
                        search_engines: ['google', 'bing']
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Dorking initiated again for ${existingSuspectName}.`);
                        apiRequestCount += 1;
                        document.getElementById('api-requests').innerText = apiRequestCount;

                        pollForResults(existingSuspectId, existingSuspectName);
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while initiating dorking.');
                });
            });

            // Profile icon functionality
            var profileIcon = document.getElementById('profile-icon');
            var accountModal = document.getElementById('account-modal');
            var logoutButtonModal = document.getElementById('logout-button-modal');

            profileIcon.addEventListener('click', function() {
                accountModal.style.display = 'block';
            });

            logoutButtonModal.addEventListener('click', function() {
                accountModal.style.display = 'none';
                alert('Logged out successfully.');
            });

            // Close modals when clicking outside of the content
            window.onclick = function(event) {
                if (event.target == addModal) {
                    addModal.style.display = 'none';
                    form.reset();
                }
                if (event.target == detailModal) {
                    detailModal.style.display = 'none';
                }
                if (event.target == accountModal) {
                    accountModal.style.display = 'none';
                }
                if (event.target == dorkModal) {
                    dorkModal.style.display = 'none';
                    dorkForm.reset();
                }
                if (event.target == existingSuspectModal) {
                    existingSuspectModal.style.display = 'none';
                }
                if (event.target == imagePreviewModal) {
                    imagePreviewModal.style.display = 'none';
                }
                if (event.target == instagramModal) {
                    instagramModal.style.display = 'none';
                }
                if (!contextMenu.contains(event.target)) {
                    contextMenu.style.display = 'none';
                }
            };

            function pollForResults(suspectId, suspectName, interval = 5000, maxAttempts = 20) {
                let attempts = 0;
                let pollingMessage = document.getElementById('polling-message');
                if (pollingMessage) {
                    pollingMessage.innerText = `Scraping in progress for ${suspectName}...`;
                    pollingMessage.style.display = 'block';
                } else {
                    console.warn('Polling message element not found.');
                }

                function checkResults() {
                    attempts++;
                    fetch(`/api/get-results?suspect_id=${encodeURIComponent(suspectId)}`)
                    .then(response => response.json())
                    .then(resultsData => {
                        if (resultsData.status === 'success') {
                            pollingMessage.style.display = 'none';
                            processResultsData(resultsData.data, suspectId, suspectName);
                            alert(`Data loaded for ${suspectName}.`);
                            updateCounts();
                            updateSuspectsList();
                        } else {
                            if (attempts < maxAttempts) {
                                setTimeout(checkResults, interval);
                            } else {
                                pollingMessage.style.display = 'none';
                                alert(`Failed to load results for ${suspectName} after multiple attempts.`);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching results:', error);
                        if (attempts < maxAttempts) {
                            setTimeout(checkResults, interval);
                        } else {
                            pollingMessage.style.display = 'none';
                            alert(`An error occurred while fetching results for ${suspectName}.`);
                        }
                    });
                }

                checkResults();
            }

            function processResultsData(data, suspectId, suspectName) {
                try {
                    if (!data) throw new Error("No data received.");

                    // Ensure the suspect node exists
                    if (cy.getElementById(suspectId).length === 0) {
                        cy.add({
                            group: 'nodes',
                            data: {
                                id: suspectId,
                                label: suspectName,
                                type: 'suspect'
                            }
                        });
                    }

                    let newNodes = [];
                    let newEdges = [];

                    for (let category in data) {
                        let items = data[category];
                        if (!Array.isArray(items)) continue;

                        const methodNodeId = `method-${category.toLowerCase()}`;

                        // Add method node if it doesn't exist
                        if (cy.getElementById(methodNodeId).length === 0) {
                            newNodes.push({
                                group: 'nodes',
                                data: {
                                    id: methodNodeId,
                                    label: category.replace('_', ' ').toUpperCase(),
                                    type: 'method'
                                }
                            });

                            newEdges.push({
                                group: 'edges',
                                data: {
                                    source: suspectId,
                                    target: methodNodeId,
                                    type: 'method-connection'
                                }
                            });
                        }

                        let domainGroups = {};
                        items.forEach(item => {
                            let domain = item.domain || 'Unknown Domain';
                            if (!domainGroups[domain]) {
                                domainGroups[domain] = [];
                            }
                            domainGroups[domain].push(item);
                        });

                        for (let domain in domainGroups) {
                            const sanitizedDomain = domain.replace(/\./g, '-');
                            const domainNodeId = `domain-${category.toLowerCase()}-${sanitizedDomain}`;
                            
                            if (cy.getElementById(domainNodeId).length === 0) {
                                newNodes.push({
                                    group: 'nodes',
                                    data: {
                                        id: domainNodeId,
                                        label: domain,
                                        type: 'domain'
                                    }
                                });

                                newEdges.push({
                                    group: 'edges',
                                    data: {
                                        source: methodNodeId,
                                        target: domainNodeId,
                                        type: 'domain-connection'
                                    }
                                });
                            }

                            domainGroups[domain].forEach(result => {
                                const resultNodeId = `result-${generateUniqueId()}`;
                                newNodes.push({
                                    group: 'nodes',
                                    data: {
                                        id: resultNodeId,
                                        label: result.title || result.link || 'Unknown',
                                        link: result.link || '#',
                                        snippet: result.snippet || 'N/A',
                                        category: result.category || 'N/A',
                                        domain: result.domain || 'N/A',
                                        type: 'result',
                                        image_url: result.image_url || ''
                                    }
                                });

                                newEdges.push({
                                    group: 'edges',
                                    data: {
                                        source: domainNodeId,
                                        target: resultNodeId,
                                        type: 'result-connection'
                                    }
                                });
                            });
                        }
                    }

                    // Add new nodes and edges to Cytoscape
                    if (newNodes.length > 0) {
                        cy.add(newNodes);
                        console.log(`Added ${newNodes.length} new nodes.`);
                    }

                    if (newEdges.length > 0) {
                        cy.add(newEdges);
                        console.log(`Added ${newEdges.length} new edges.`);
                    }

                    // Apply layout and update UI
                    cy.layout({ name: 'cose', padding: 10, animate: true }).run();

                    // Update UI counts and Suspects List
                    updateCounts();
                    updateSuspectsList();

                    console.log('Results data processed and graph updated successfully.');
                } catch (error) {
                    console.error('Error processing results data:', error);
                    alert('An error occurred while processing the results data.');
                }
            }

            function generateUniqueId() {
                return 'node-' + Math.random().toString(36).substr(2, 9);
            }

            window.addEventListener('resize', function() {
                cy.resize();
                cy.fit();
            });

            // Function to update counts
            function updateCounts() {
                document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                document.getElementById('total-connections').innerText = cy.edges().length;
            }

            // Function to update Suspects List
            function updateSuspectsList() {
                var suspectsContainer = document.getElementById('suspects-container');
                suspectsContainer.innerHTML = ''; // Clear existing list

                var suspects = cy.nodes().filter(node => node.data('type') === 'suspect');

                suspects.forEach(suspect => {
                    var suspectItem = document.createElement('div');
                    suspectItem.classList.add('suspect-item');
                    suspectItem.innerHTML = `
                        <strong>${suspect.data('label') || 'Unnamed Suspect'}</strong><br>
                        Email: ${suspect.data('email') || 'N/A'}<br>
                        NIC: ${suspect.data('nic') || 'N/A'}<br>
                        Social Media: ${suspect.data('socialMedia') || 'N/A'}
                    `;
                    suspectItem.dataset.id = suspect.id();

                    // Add click event to select the node in the graph
                    suspectItem.addEventListener('click', function() {
                        cy.nodes().unselect();
                        var node = cy.getElementById(this.dataset.id);
                        node.select();
                        cy.center(node);
                        // Highlight the list item
                        document.querySelectorAll('.suspect-item').forEach(item => item.classList.remove('selected'));
                        this.classList.add('selected');
                    });

                    suspectsContainer.appendChild(suspectItem);
                });
            }

            // Initial Suspects List Update
            updateSuspectsList();

            // Function to handle when nodes are added or removed
            cy.on('add remove', 'node', function(evt){
                updateCounts();
                updateSuspectsList();
            });

            // Function to handle when nodes are selected via the graph
            cy.on('select unselect', 'node[type="suspect"]', function(evt){
                var selected = cy.$('node[type="suspect"]:selected');
                document.querySelectorAll('.suspect-item').forEach(item => {
                    if (selected.length > 0 && item.dataset.id === selected.id()) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
            });
        });
    </script>
        <script>
            // Check authentication state when document loads
            document.addEventListener('DOMContentLoaded', function() {
                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        // User is signed in
                        // Get reference to Firestore document
                        db.collection('users').doc(user.uid).get()
                            .then((doc) => {
                                if (doc.exists) {
                                    // Update username from Firestore data
                                    document.getElementById('account-username').textContent = doc.data().username || 'Not Set';
                                    // Update email from Firebase Auth
                                    document.getElementById('account-email').textContent = user.email;
                                } else {
                                    console.log("No user document found!");
                                }
                            })
                            .catch((error) => {
                                console.error("Error getting user document:", error);
                            });
                    } else {
                        // No user is signed in, redirect to login
                        window.location.replace('login.html');
                    }
                });

                // Handle logout button click
                document.getElementById('logout-button-modal').addEventListener('click', function() {
                    auth.signOut().then(() => {
                        window.location.replace('login.html');
                    }).catch((error) => {
                        console.error("Error signing out:", error);
                    });
                });
            });
        </script>
    
</body>
</html>
