<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta and Title -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShadowByte - Suspect Visualization</title>
    <!-- External Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet" />
    <!-- Styles -->
    <style>
        /* General styles */
        body {
            margin: 0;
            font-family: 'Ubuntu', sans-serif;
            background-color: #1e2a38;
            color: #ffffff;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        /* Sidebar styles (Left Side) */
        .sidebar {
            width: 300px;
            background-color: #2b3a4b;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .sidebar h1 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #58a6ff;
            text-align: center;
        }
        .sidebar h1 i {
            margin-right: 10px;
        }
        .sidebar .section {
            margin-bottom: 20px;
        }
        .sidebar .section h2 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #58a6ff;
        }
        .sidebar .section p {
            margin: 5px 0;
        }
        /* Added frame to overview section */
        .overview-frame {
            border: 1px solid #58a6ff;
            padding: 15px;
            border-radius: 5px;
        }
        /* Main content styles */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .main-content .header input {
            width: 60%;
            padding: 8px;
            background-color: #1e2a38;
            border: 1px solid #3a4a5b;
            border-radius: 5px;
            color: #ffffff;
        }
        .main-content .header {
            background-color: #2b3a4b;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative; /* Ensure positioning context */
        }

        .main-content .header .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .main-content .header .buttons {
            display: flex;
            gap: 10px;
        }

        .main-content .header .buttons button {
            background-color: #1e2a38;
            color: #ffffff;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
        }

        .main-content .header .buttons button i {
            margin-right: 5px;
        }

        .main-content .header .buttons button:hover {
            background-color: #32495b;
        }

        .main-content .header .profile-icon {
            font-size: 28px;
            cursor: pointer;
            color: #ffffff;
            /* Add the following to align it to the top right */
            margin-left: auto;
        }
        .main-content .graph {
            flex-grow: 1;
            position: relative;
        }
        #cy {
            width: 100%;
            height: 100%;
        }
        .profile-icon {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #ffffff;
            z-index: 1001;
        }

        /* Footer styles */
        .footer {
            background-color: #2b3a4b;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .footer a {
            color: #ffffff;
            text-decoration: none;
        }
        .footer a i {
            margin-right: 5px;
        }
        .footer div a i {
            margin-right: 5px;
        }
        /* Tool panel styles (Right Side) */
        .tool-panel {
            width: 300px;
            background-color: #2b3a4b;
            padding: 30px 20px 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .tool-panel .category {
            margin-bottom: 20px;
        }
        .tool-panel .category h2 {
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            background-color: #1e2a38;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .tool-panel .category h2 i {
            margin-right: 10px;
        }
        .tool-panel .category h2:hover {
            background-color: #3a4a5b;
        }
        .tool-panel .tool-list {
            margin-top: 10px;
            padding-left: 20px;
            display: none;
        }
        .tool-panel .tool-list button {
            width: 100%;
            background-color: #1e2a38;
            color: #ffffff;
            border: none;
            padding: 10px;
            text-align: left;
            display: flex;
            align-items: center;
            font-size: 14px;
            margin-bottom: 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .tool-panel .tool-list button i {
            margin-right: 10px;
            color: #58a6ff;
        }
        .tool-panel .tool-list button:hover {
            background-color: #32495b;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #2b3a4b;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 400px;
            border-radius: 10px;
            color: #ffffff;
        }
        .modal-content h2 {
            margin-top: 0;
            color: #58a6ff;
        }
        .modal-content label {
            display: block;
            margin: 15px 0 5px;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 8px;
            background-color: #1e2a38;
            border: 1px solid #3a4a5b;
            border-radius: 5px;
            color: #ffffff;
        }
        .modal-content .buttons {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal-content .buttons button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .modal-content .buttons .cancel {
            background-color: #555;
            color: #fff;
        }
        .modal-content .buttons .submit {
            background-color: #58a6ff;
            color: #fff;
        }
        .modal-content .buttons button:hover {
            opacity: 0.8;
        }
        /* Suspect detail modal */
        .detail-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        .detail-modal-content {
            background-color: #2b3a4b;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 400px;
            border-radius: 10px;
            color: #ffffff;
        }
        .detail-modal-content h2 {
            margin-top: 0;
            color: #58a6ff;
        }
        /* Updated: Separate sections for suspect and result details */
        .detail-modal-content #suspect-details,
        .detail-modal-content #result-details {
            margin-bottom: 15px;
        }
        .detail-modal-content #result-details a {
            color: #58a6ff;
            text-decoration: none;
        }
        .detail-modal-content #result-details a:hover {
            text-decoration: underline;
        }
        .detail-modal-content label {
            display: block;
            margin: 10px 0 5px;
        }

        .detail-modal-content p span {
            font-weight: bold;
        }
        .detail-modal-content .close-btn {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }
        .detail-modal-content .close-btn button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #58a6ff;
            color: #fff;
        }
        .detail-modal-content .close-btn button:hover {
            opacity: 0.8;
        }
        /* Account modal styles */
        .account-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        .account-modal-content {
            background-color: #2b3a4b;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            border-radius: 10px;
            color: #ffffff;
            text-align: center;
        }
        .account-modal-content h2 {
            margin-top: 0;
            color: #58a6ff;
        }
        .account-modal-content p {
            margin: 15px 0;
        }
        .account-modal-content button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #58a6ff;
            color: #fff;
            margin-top: 20px;
        }
        .account-modal-content button:hover {
            opacity: 0.8;
        }
        /* Modal for Dork Suspect Options */
        #dork-modal .modal-content label {
            margin: 10px 0 5px;
        }
        #dork-modal .modal-content .tool-list {
            padding-left: 20px;
        }
        /* Modal for Existing Suspect */
        #existing-suspect-modal .modal-content p span {
            font-weight: bold;
        }
        /* Image Preview Modal */
        #image-preview-modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        #image-preview-content {
            background-color: #2b3a4b;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 600px;
            border-radius: 10px;
            color: #ffffff;
            text-align: center;
        }
        #image-preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
        }
        #image-preview-content .close-btn {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        #image-preview-content .close-btn button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #58a6ff;
            color: #fff;
        }
        #image-preview-content .close-btn button:hover {
            opacity: 0.8;
        }

        /* Custom Context Menu Styles */
        #context-menu {
            display: none;
            position: absolute;
            z-index: 10000;
            width: 150px;
            background-color: #2b3a4b;
            border: 1px solid #555;
            border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }

        #context-menu ul {
            list-style: none;
            padding: 5px 0;
            margin: 0;
        }

        #context-menu ul li {
            padding: 8px 12px;
            cursor: pointer;
            color: #fff;
        }

        #context-menu ul li:hover {
            background-color: #32495b;
        }
        /* Context Menu Styles */
        #context-menu {
            display: none;
            position: absolute;
            z-index: 1000;
            width: 150px;
            background-color: #17264a;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        #context-menu ul {
            list-style: none;
            padding: 5px 0;
            margin: 0;
        }
        #context-menu ul li {
            padding: 8px 12px;
            cursor: pointer;
        }
        #context-menu ul li:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar (Left Side) -->
        <div class="sidebar">
            <h1><i class="fas fa-user-secret"></i> Suspect Network</h1>
            <div class="section overview-frame">
                <h2>Overall Details</h2>
                <p>Total Suspects: <span id="total-suspects">0</span></p>
                <p>Total Connections: <span id="total-connections">0</span></p>
            </div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <input id="search" placeholder="Search in the graph..." type="text" />
                <div class="header-right">
                    <div class="buttons">
                        <button id="add-node"><i class="fas fa-plus"></i> Add Suspect</button>
                        <button id="delete-node"><i class="fas fa-trash"></i> Delete Suspect</button>
                    </div>
                </div>
            </div>
            <div class="graph">
                <div id="cy"></div>
            </div>
            <div class="footer">
                <a href="#"><i class="fas fa-server"></i> API requests: <span id="api-requests">0</span></a>
                <div>
                    <a href="#"><i class="fas fa-book"></i> Documentation</a> |
                    <a href="#"><i class="fas fa-code"></i> API</a> |
                    <a href="#"><i class="fas fa-comment"></i> Send feedback</a>
                </div>
            </div>
        </div>
        <!-- Profile Icon -->
        <i class="fas fa-user-circle profile-icon" id="profile-icon"></i>
        <!-- Tool Panel (Right Side) -->
        <div class="tool-panel">
            <!-- Tool panel content -->
            <div class="category">
                <h2><i class="fas fa-tools"></i> Tools</h2>
                <div class="tool-list">
                    <button id="add-connection"><i class="fas fa-link"></i> Add Connection</button>
                    <button id="analyze-network"><i class="fas fa-search"></i> Analyze Network</button>
                    <button id="export-data"><i class="fas fa-file-export"></i> Export Data</button>
                    <button id="import-data"><i class="fas fa-file-import"></i> Import Data</button>
                    <button id="settings"><i class="fas fa-cog"></i> Settings</button>
                </div>
            </div>
            <div class="category">
                <h2><i class="fas fa-database"></i> Data Collection</h2>
                <div class="tool-list">
                    <button id="web-scraping"><i class="fas fa-globe"></i> Web Scraping</button>
                    <button id="api-integration"><i class="fas fa-plug"></i> API Integration</button>
                    <button id="social-media-scraping"><i class="fas fa-hashtag"></i> Social Media Scraping</button>
                    <button id="dork-suspect"><i class="fas fa-magnifying-glass"></i> Dork Suspect</button>
                </div>
            </div>
            <div class="category">
                <h2><i class="fas fa-chart-bar"></i> Analytics</h2>
                <div class="tool-list">
                    <button id="generate-reports"><i class="fas fa-file-alt"></i> Generate Reports</button>
                    <button id="statistics"><i class="fas fa-chart-pie"></i> Statistics</button>
                    <button id="trend-analysis"><i class="fas fa-chart-line"></i> Trend Analysis</button>
                </div>
            </div>
            <div class="category">
                <h2><i class="fas fa-user-shield"></i> Security</h2>
                <div class="tool-list">
                    <button id="user-management"><i class="fas fa-users-cog"></i> User Management</button>
                    <button id="access-control"><i class="fas fa-shield-alt"></i> Access Control</button>
                    <button id="audit-logs"><i class="fas fa-clipboard-list"></i> Audit Logs</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Adding Node -->
    <div id="node-modal" class="modal">
        <div class="modal-content">
            <h2>Add Suspect</h2>
            <form id="node-form">
                <!-- Removed Suspect ID field -->
                <label for="full-name">Full Name:</label>
                <input type="text" id="full-name" name="full-name" required />
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" />
                <label for="nic">NIC:</label>
                <input type="text" id="nic" name="nic" />
                <label for="social-media">Social Media Accounts:</label>
                <input type="text" id="social-media" name="social-media" placeholder="Comma-separated usernames" />
                <div class="buttons">
                    <button type="button" class="cancel" id="node-cancel-button">Cancel</button>
                    <button type="submit" class="submit">Add Suspect</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal for Node Details -->
    <div id="detail-modal" class="detail-modal">
        <div class="detail-modal-content">
            <h2>Node Details</h2>
            <!-- Suspect Details -->
            <div id="suspect-details">
                <p><span>ID:</span> <span id="detail-id"></span></p>
                <p><span>Full Name:</span> <span id="detail-fullname"></span></p>
                <p><span>Email:</span> <span id="detail-email"></span></p>
                <p><span>NIC:</span> <span id="detail-nic"></span></p>
                <p><span>Social Media:</span> <span id="detail-socialmedia"></span></p>
            </div>
            <!-- Result Details -->
            <div id="result-details" style="display: none;">
                <p><span>Title:</span> <span id="detail-title"></span></p>
                <p><span>Link:</span> <a href="#" id="detail-link" target="_blank">View Link</a></p>
                <p><span>Snippet:</span> <span id="detail-snippet"></span></p>
                <p><span>Category:</span> <span id="detail-category"></span></p>
                <!-- Image Preview for Google Images -->
                <div id="image-preview" style="display: none;">
                    <img id="preview-image-full" src="" alt="Image Preview" />
                </div>
            </div>
            <div class="close-btn">
                <button id="close-detail-modal">Close</button>
            </div>
        </div>
    </div>
    <!-- Image Preview Modal -->
    <div id="image-preview-modal" class="modal">
        <div class="modal-content" id="image-preview-content">
            <h2>Image Preview</h2>
            <img id="preview-image-full" src="" alt="Image Preview" />
            <div class="close-btn">
                <button id="close-image-preview">Close</button>
            </div>
        </div>
    </div>
    <!-- Account Modal -->
    <div id="account-modal" class="account-modal">
        <div class="account-modal-content">
            <h2>Account Details</h2>
            <p><strong>Username:</strong> user123</p>
            <p><strong>Email:</strong> user@example.com</p>
            <!-- Add more account details as needed -->
            <button id="logout-button-modal">Logout</button>
        </div>
    </div>
    <!-- Modal for Dork Suspect Options -->
    <div id="dork-modal" class="modal">
        <div class="modal-content">
            <h2>Dork Suspect</h2>
            <form id="dork-form">
                <label for="search-all">Search All Name Types:</label>
                <select id="search-all" name="search-all" required>
                    <option value="">Select</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
                <label for="search-engines">Select Search Engines:</label>
                <div>
                    <input type="checkbox" id="google" name="search-engines" value="google">
                    <label for="google">Google</label>
                </div>
                <div>
                    <input type="checkbox" id="bing" name="search-engines" value="bing">
                    <label for="bing">Bing</label>
                </div>
                <div class="buttons">
                    <button type="button" class="cancel" id="dork-cancel-button">Cancel</button>
                    <button type="submit" class="submit">Start Dorking</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal for Existing Suspect -->
    <div id="existing-suspect-modal" class="modal">
        <div class="modal-content">
            <h2>Suspect Already Exists</h2>
            <p>The suspect "<span id="existing-suspect-name"></span>" has already been scraped.</p>
            <p>Do you want to use existing data or scrape again?</p>
            <div class="buttons">
                <button id="use-existing">Use Existing Data</button>
                <button id="scrape-again">Scrape Again</button>
            </div>
        </div>
    </div>
    <!-- Polling Message -->
    <div id="polling-message" style="display: none; color: #fff; text-align: center; padding: 10px; background-color: rgba(0, 0, 0, 0.5); position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1003;">
        Scraping in progress...
    </div>

    <div id="context-menu">
        <ul>
            <li id="context-dorking">Dorking</li>
            <li id="context-delete">Delete Node</li>
        </ul>
    </div>

    <script>
        // Declare existingSuspectName globally
        var existingSuspectName = '';
        var existingSuspectId = '';
    
        // Toggle tool lists
        document.querySelectorAll('.tool-panel .category h2').forEach(header => {
            header.addEventListener('click', () => {
                const toolList = header.nextElementSibling;
                toolList.style.display = toolList.style.display === 'block' ? 'none' : 'block';
            });
        });
    
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Cytoscape
            var cy = cytoscape({
                container: document.getElementById('cy'),
                style: [
                    {
                        selector: 'node[type="method"]',
                        style: {
                            'background-color': '#ff5722',
                            'shape': 'ellipse',
                            'label': 'data(label)',
                            'font-size': '14px',
                            'color': '#fff',
                            'text-valign': 'center',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="domain"]',
                        style: {
                            'background-color': '#2196f3',
                            'shape': 'rectangle',
                            'label': 'data(label)',
                            'font-size': '12px',
                            'color': '#fff',
                            'text-valign': 'center',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"]',
                        style: {
                            'background-color': '#4caf50',
                            'shape': 'diamond',
                            'label': 'data(label)',
                            'font-size': '10px',
                            'color': '#fff',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'edge[type="method-connection"]',
                        style: {
                            'line-color': '#ff5722',
                            'target-arrow-color': '#ff5722',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: 'edge[type="domain-connection"]',
                        style: {
                            'line-color': '#2196f3',
                            'target-arrow-color': '#2196f3',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: 'edge[type="result-connection"]',
                        style: {
                            'line-color': '#4caf50',
                            'target-arrow-color': '#4caf50',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: 'node[type="suspect"]',
                        style: {
                            'width': '50px',
                            'height': '50px',
                            'background-color': '#555',
                            'shape': 'ellipse',
                            'border-color': '#000',
                            'border-width': 3,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '12px',
                            'text-valign': 'center',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="source"]',
                        style: {
                            'width': '60px',
                            'height': '60px',
                            'background-color': '#007bff',
                            'shape': 'rectangle',
                            'border-color': '#000',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '14px',
                            'text-valign': 'center',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"][category="google_web_pages"]',
                        style: {
                            'background-color': '#1f77b4',
                            'shape': 'ellipse',
                            'border-color': '#333',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '10px',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"][category="google_images"]',
                        style: {
                            'background-color': '#ff7f0e',
                            'shape': 'rectangle',
                            'border-color': '#333',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '10px',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"][category="google_documents"]',
                        style: {
                            'background-color': '#2ca02c',
                            'shape': 'diamond',
                            'border-color': '#333',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '10px',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"][category="bing_web_pages"]',
                        style: {
                            'background-color': '#d62728',
                            'shape': 'triangle',
                            'border-color': '#333',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '10px',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'node[type="result"]',
                        style: {
                            'background-color': '#9467bd',
                            'shape': 'hexagon',
                            'border-color': '#333',
                            'border-width': 2,
                            'content': 'data(label)',
                            'color': '#fff',
                            'font-size': '10px',
                            'text-valign': 'bottom',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#ccc',
                            'target-arrow-color': '#ccc',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: ':selected',
                        style: {
                            'background-color': '#ffa500',
                            'line-color': '#ffa500',
                            'target-arrow-color': '#ffa500',
                            'source-arrow-color': '#ffa500',
                            'border-width': 2,
                            'border-color': '#ffffff'
                        }
                    }

                ],
                elements: [],
                layout: {
                    name: 'cose',
                    padding: 10
                }
            });
    
            // Initialize API request counter
            let apiRequestCount = 0;
    
            // Modal elements
            var addModal = document.getElementById('node-modal');
            var form = document.getElementById('node-form');
            var nodeCancelBtn = document.getElementById('node-cancel-button');
    
            // Context Menu
            var contextMenu = document.getElementById('context-menu');
            var contextDorking = document.getElementById('context-dorking');
            var contextDelete = document.getElementById('context-delete');
    
            // Open modal on 'Add Node' click
            document.getElementById('add-node').addEventListener('click', function() {
                addModal.style.display = 'block';
            });
    
            // Close node modal on 'Cancel' click
            nodeCancelBtn.addEventListener('click', function() {
                addModal.style.display = 'none';
                form.reset();
            });
    
            // Handle form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
    
                // Collect form data
                var fullName = document.getElementById('full-name').value.trim();
                var email = document.getElementById('email').value.trim();
                var nic = document.getElementById('nic').value.trim();
                var socialMedia = document.getElementById('social-media').value.trim();
    
                // Prepare data to send
                var suspectData = {
                    suspect_name: fullName,
                    email: email,
                    nic: nic,
                    social_media: socialMedia
                };
    
                // Send POST request to add suspect
                fetch('/api/add-suspect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(suspectData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        apiRequestCount += 1;
                        document.getElementById('api-requests').innerText = apiRequestCount;
    
                        // Add node to the graph using suspect_id as ID
                        cy.add({
                            group: 'nodes',
                            data: {
                                id: data.suspect_id,
                                label: fullName,
                                email: email || '',
                                nic: nic || '',
                                socialMedia: socialMedia || '',
                                type: 'suspect'
                            }
                        });
    
                        // Refresh layout
                        cy.layout({ name: 'cose', padding: 10, animate: true }).run();
    
                        // Update overall details
                        document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                        document.getElementById('total-connections').innerText = cy.edges().length;
                    } else if (data.status === 'exists') {
                        // Suspect already exists
                        existingSuspectId = data.suspect_id;
                        openExistingSuspectModal(data.suspect_id, fullName);
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while adding the suspect.');
                });
    
                // Close modal and reset form
                addModal.style.display = 'none';
                form.reset();
            });
    
            // Delete node functionality
            document.getElementById('delete-node').addEventListener('click', function() {
                var selectedNodes = cy.$(':selected');
                if (selectedNodes.length > 0) {
                    if (confirm('Are you sure you want to delete the selected suspect(s) and all their connections?')) {
                        selectedNodes.forEach(node => {
                            var suspectId = node.id();
                            // Send DELETE request to backend
                            fetch('/api/delete-suspect', {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ suspect_id: suspectId })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    console.log(`Deleted suspect ID: ${suspectId}`);
                                } else {
                                    console.error(`Error deleting suspect: ${data.error}`);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
    
                            // Remove connected edges and node
                            cy.remove(node);
                        });
    
                        // Update overall details
                        document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                        document.getElementById('total-connections').innerText = cy.edges().length;
                    }
                } else {
                    alert('Please select a suspect to delete.');
                }
            });
    
            // Suspect detail modal elements
            var detailModal = document.getElementById('detail-modal');
            var closeDetailBtn = document.getElementById('close-detail-modal');
    
            // Image preview modal elements
            var imagePreviewModal = document.getElementById('image-preview-modal');
            var closeImagePreviewBtn = document.getElementById('close-image-preview');
    
            // Node selection and detail display
            cy.on('tap', 'node', function(evt){
                var node = evt.target;
                cy.$('node').unselect();
                node.select();

                var type = node.data('type');

                if(type === 'suspect') {
                    // Assign the selected suspect
                    selectedSuspect = node.data();
                    console.log('Selected Suspect:', selectedSuspect);

                    // Display Suspect Details
                    document.getElementById('suspect-details').style.display = 'block';
                    document.getElementById('result-details').style.display = 'none';

                    document.getElementById('detail-id').innerText = node.data('id') || 'N/A';
                    document.getElementById('detail-fullname').innerText = node.data('label') || 'N/A';
                    document.getElementById('detail-email').innerText = node.data('email') || 'N/A';
                    document.getElementById('detail-nic').innerText = node.data('nic') || 'N/A';
                    document.getElementById('detail-socialmedia').innerText = node.data('socialMedia') || 'N/A';
                }
                else if(type === 'source') {
                    // Display Source Details
                    document.getElementById('suspect-details').style.display = 'none';
                    document.getElementById('result-details').style.display = 'block';

                    document.getElementById('detail-title').innerText = node.data('label') || 'Source';
                    document.getElementById('detail-link').href = '#';
                    document.getElementById('detail-link').innerText = 'N/A';
                    document.getElementById('detail-snippet').innerText = '';
                    document.getElementById('detail-category').innerText = node.data('category') || 'N/A';
                    document.getElementById('image-preview').style.display = 'none';
                }
                else if(type === 'result') {
                    // Display Result Details
                    document.getElementById('suspect-details').style.display = 'none';
                    document.getElementById('result-details').style.display = 'block';

                    document.getElementById('detail-title').innerText = node.data('label') || 'N/A';
                    var linkElement = document.getElementById('detail-link');
                    linkElement.href = node.data('link') || '#';
                    linkElement.innerText = node.data('link') ? 'View Link' : 'N/A';
                    document.getElementById('detail-snippet').innerText = node.data('snippet') || 'N/A';
                    document.getElementById('detail-category').innerText = node.data('category') || 'N/A';

                    // Check if category is google_images to show image preview
                    if(node.data('category') === 'google_images' && node.data('image_url')) {
                        document.getElementById('preview-image-full').src = node.data('image_url');
                        imagePreviewModal.style.display = 'block';
                    } else {
                        document.getElementById('image-preview').style.display = 'none';
                    }
                }

                detailModal.style.display = 'block';
            });
    
            // Close detail modal
            closeDetailBtn.addEventListener('click', function() {
                detailModal.style.display = 'none';
                document.getElementById('image-preview').style.display = 'none';
            });
    
            // Close image preview modal
            closeImagePreviewBtn.addEventListener('click', function() {
                imagePreviewModal.style.display = 'none';
            });
    
            // Right-click context menu
            cy.on('cxttap', 'node', function(evt){
                var node = evt.target;
                var evtPos = evt.renderedPosition;
                contextMenu.style.display = 'block';
                contextMenu.style.left = evt.originalEvent.pageX + 'px';
                contextMenu.style.top = evt.originalEvent.pageY + 'px';
                contextMenu.currentNode = node;
            });
    
            // Handle context menu actions
            contextDorking.addEventListener('click', function() {
                var node = contextMenu.currentNode;
                if(node && node.data('type') === 'suspect') {
                    // Open Dorking modal for the node
                    selectedSuspect = node.data();
                    dorkModal.style.display = 'block';
                }
                contextMenu.style.display = 'none';
            });
    
            contextDelete.addEventListener('click', function() {
                var node = contextMenu.currentNode;
                if(node) {
                    if (confirm('Are you sure you want to delete this node and its connections?')) {
                        var suspectId = node.id();
                        // Send DELETE request to backend
                        fetch('/api/delete-suspect', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ suspect_id: suspectId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                cy.remove(node);
                                document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                                document.getElementById('total-connections').innerText = cy.edges().length;
                            } else {
                                alert(`Error: ${data.error}`);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while deleting the suspect.');
                        });
                    }
                }
                contextMenu.style.display = 'none';
            });
    
            // Close context menu on click elsewhere
            document.addEventListener('click', function(e) {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.style.display = 'none';
                }
            });
    
            // Enable selecting and deleting nodes directly
            cy.userZoomingEnabled(true);
            cy.userPanningEnabled(true);
            cy.boxSelectionEnabled(true);
            //cy.selectable(true);
    
            // Initialize Selected Suspect
            var selectedSuspect = null;
    
            // Modal elements for Dork Suspect
            var dorkModal = document.getElementById('dork-modal');
            var dorkForm = document.getElementById('dork-form');
            var dorkCancelBtn = document.getElementById('dork-cancel-button');
    
            // Handle Dork Suspect form submission
            dorkForm.addEventListener('submit', function(e) {
                e.preventDefault();
    
                var searchAll = document.getElementById('search-all').value;
                var searchEngines = [];
                if (document.getElementById('google').checked) {
                    searchEngines.push('google');
                }
                if (document.getElementById('bing').checked) {
                    searchEngines.push('bing');
                }
    
                if (searchEngines.length === 0) {
                    alert('Please select at least one search engine.');
                    return;
                }
    
                var dorkData = {
                    suspect_id: selectedSuspect.id,
                    search_all: searchAll === 'yes',
                    search_engines: searchEngines
                };
    
                // Send POST request to dork-suspect endpoint
                fetch('/api/dork-suspect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dorkData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Dorking initiated for ${selectedSuspect.label}.`);
                        apiRequestCount += 1;
                        document.getElementById('api-requests').innerText = apiRequestCount;
    
                        // Start polling for results
                        pollForResults(selectedSuspect.id, selectedSuspect.label);
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while initiating dorking.');
                });
    
                // Close the modal
                dorkModal.style.display = 'none';
                dorkForm.reset();
            });
    
            // Close Dork Modal on 'Cancel'
            dorkCancelBtn.addEventListener('click', function() {
                dorkModal.style.display = 'none';
                dorkForm.reset();
            });
    
            // Modal for Existing Suspect
            var existingSuspectModal = document.getElementById('existing-suspect-modal');
            var useExistingBtn = document.getElementById('use-existing');
            var scrapeAgainBtn = document.getElementById('scrape-again');
    
            function openExistingSuspectModal(suspectId, suspectName) {
                existingSuspectModal.style.display = 'block';
                document.getElementById('existing-suspect-name').innerText = suspectName;
                existingSuspectId = suspectId;
            }
    
            useExistingBtn.addEventListener('click', function() {
                existingSuspectModal.style.display = 'none';
                // Fetch and visualize existing data using suspect_id
                fetch(`/api/get-results?suspect_id=${encodeURIComponent(existingSuspectId)}`)
                .then(response => response.json())
                .then(resultsData => {
                    console.log('Received resultsData:', resultsData); // For debugging
                    if (resultsData.status === 'success') {
                        const data = resultsData.data;
                        // Process the data
                        processResultsData(data);
                        alert(`Loaded existing data for ${existingSuspectName}.`);
                        // Update counts
                        document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                        document.getElementById('total-connections').innerText = cy.edges().length;
                    } else {
                        alert(`Error: ${resultsData.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error fetching existing data:', error);
                    alert('An error occurred while fetching existing data.');
                });
            });
    
            scrapeAgainBtn.addEventListener('click', function() {
                existingSuspectModal.style.display = 'none';
                // Initiate scraping again using existingSuspectId
                fetch('/api/dork-suspect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        suspect_id: existingSuspectId,
                        search_all: true,
                        search_engines: ['google', 'bing']
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Dorking initiated again for ${existingSuspectName}.`);
                        apiRequestCount += 1;
                        document.getElementById('api-requests').innerText = apiRequestCount;
    
                        // Start polling for results
                        pollForResults(existingSuspectId, existingSuspectName);
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while initiating dorking.');
                });
            });
    
            // Profile icon functionality
            var profileIcon = document.getElementById('profile-icon');
            var accountModal = document.getElementById('account-modal');
            var logoutButtonModal = document.getElementById('logout-button-modal');
    
            profileIcon.addEventListener('click', function() {
                accountModal.style.display = 'block';
            });
    
            logoutButtonModal.addEventListener('click', function() {
                accountModal.style.display = 'none';
                alert('Logged out successfully.');
                // Implement actual logout functionality here
            });
    
            // Close modals when clicking outside of the content
            window.onclick = function(event) {
                if (event.target == addModal) {
                    addModal.style.display = 'none';
                    form.reset();
                }
                if (event.target == detailModal) {
                    detailModal.style.display = 'none';
                }
                if (event.target == accountModal) {
                    accountModal.style.display = 'none';
                }
                if (event.target == dorkModal) {
                    dorkModal.style.display = 'none';
                    dorkForm.reset();
                }
                if (event.target == existingSuspectModal) {
                    existingSuspectModal.style.display = 'none';
                }
                if (event.target == imagePreviewModal) {
                    imagePreviewModal.style.display = 'none';
                }
            };
    
            function pollForResults(suspectId, suspectName, interval = 5000, maxAttempts = 20) {
                let attempts = 0;
                let pollingMessage = document.getElementById('polling-message');
                if (pollingMessage) {
                    pollingMessage.innerText = `Scraping in progress for ${suspectName}...`;
                    pollingMessage.style.display = 'block';
                } else {
                    console.warn('Polling message element not found.');
                }
    
                function checkResults() {
                    attempts++;
                    fetch(`/api/get-results?suspect_id=${encodeURIComponent(suspectId)}`)
                    .then(response => response.json())
                    .then(resultsData => {
                        if (resultsData.status === 'success') {
                            pollingMessage.style.display = 'none';
                            // Process the data
                            processResultsData(resultsData.data);
                            alert(`Data loaded for ${suspectName}.`);
                            // Update counts
                            document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                            document.getElementById('total-connections').innerText = cy.edges().length;
                        } else {
                            if (attempts < maxAttempts) {
                                // Try again after interval
                                setTimeout(checkResults, interval);
                            } else {
                                pollingMessage.style.display = 'none';
                                alert(`Failed to load results for ${suspectName} after multiple attempts.`);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching results:', error);
                        if (attempts < maxAttempts) {
                            // Try again after interval
                            setTimeout(checkResults, interval);
                        } else {
                            pollingMessage.style.display = 'none';
                            alert(`An error occurred while fetching results for ${suspectName}.`);
                        }
                    });
                }
    
                // Start the polling
                checkResults();
            }
    
            /**
             * Function to process results data and add to Cytoscape graph
             * @param {Object} data - The categorized results data from the backend
             */
            function processResultsData(data) {
                try {
                    // Define styling based on category is handled by stylesheet
    
                    // Identify the main suspect node ID
                    const suspectId = selectedSuspect.id;
    
                    // Check if the main suspect node exists; if not, add it
                    if (cy.getElementById(suspectId).length === 0) {
                        cy.add({
                            group: 'nodes',
                            data: {
                                id: suspectId,
                                label: selectedSuspect.label,
                                type: 'suspect',
                                email: selectedSuspect.email,
                                nic: selectedSuspect.nic,
                                socialMedia: selectedSuspect.socialMedia
                            }
                        });
                    }
    
                    // Prepare arrays to batch add nodes and edges
                    let newNodes = [];
                    let newEdges = [];
    
                    for (let category in data) { // Iterate over each category
                        let items = data[category];
                        let domainGroups = {};
    
                        items.forEach(item => {
                            let domain = item.domain || 'unknown_domain';
                            if (!domainGroups[domain]) {
                                domainGroups[domain] = [];
                            }
                            domainGroups[domain].push(item);
                        });
    
                        for (let domain in domainGroups) {
                            let domainItems = domainGroups[domain];
                            domainItems.forEach(item => {
                                // Generate a unique node ID
                                let nodeId = generateUniqueId();
    
                                // Define node label based on available data
                                let label = item.title || item.link || 'Unknown';
    
                                // Avoid adding duplicate nodes based on a unique attribute (e.g., link)
                                if (item.link && cy.nodes(`[data-link="${item.link}"]`).length > 0) {
                                    // Node already exists based on link
                                    return;
                                }
    
                                // Enrich node data with additional metadata
                                let nodeData = {
                                    id: nodeId,
                                    label: label,
                                    link: item.link || '',
                                    snippet: item.snippet || '',
                                    category: category,
                                    domain: domain,
                                    type: 'result',
                                    image_url: item.image_url || '' // For image-related categories
                                };
    
                                // Add node to the newNodes array
                                newNodes.push({
                                    group: 'nodes',
                                    data: nodeData
                                });
    
                                // Add an edge connecting this node to the main suspect
                                newEdges.push({
                                    group: 'edges',
                                    data: {
                                        source: suspectId,
                                        target: nodeId
                                    }
                                });
                            });
                        }
                    }
    
                    // Ensure newNodes and newEdges are arrays
                    newNodes = Array.isArray(newNodes) ? newNodes : [newNodes];
                    newEdges = Array.isArray(newEdges) ? newEdges : [newEdges];
    
                    // Batch add nodes and edges to Cytoscape
                    cy.batch(() => {
                        cy.add(newNodes);
                        cy.add(newEdges);
                    });
    
                    // Apply layout after adding new elements
                    cy.layout({ name: 'cose', padding: 10, animate: true }).run();
    
                    // Update overall details
                    document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                    document.getElementById('total-connections').innerText = cy.edges().length;
    
                    console.log('Results data processed and graph updated successfully.');
                } catch (error) {
                    console.error('Error processing results data:', error);
                    alert('An error occurred while processing the results data.');
                }
            }
    
            /**
             * Function to generate a unique ID for nodes
             * @returns {string} - A unique identifier string
             */
            function generateUniqueId() {
                return 'node-' + Math.random().toString(36).substr(2, 9);
            }
    
            // Add Connection functionality
            document.getElementById('add-connection').addEventListener('click', function() {
                var selectedNodes = cy.$('node:selected');
                if (selectedNodes.length === 2) {
                    var source = selectedNodes[0].id();
                    var target = selectedNodes[1].id();
    
                    // Send POST request to backend to add connection
                    fetch('/api/add-connection', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ source_id: source, target_id: target })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Add edge to the graph
                            cy.add({
                                group: 'edges',
                                data: { source: source, target: target }
                            });
                            cy.layout({ name: 'cose', padding: 10, animate: true }).run();
                            // Update total connections
                            document.getElementById('total-connections').innerText = cy.edges().length;
                        } else {
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while adding the connection.');
                    });
                } else {
                    alert('Please select exactly two suspects to create a connection.');
                }
            });
    
            // Web Scraping Tool
            document.getElementById('web-scraping').addEventListener('click', function() {
                if (selectedSuspect && selectedSuspect.type === 'suspect') {
                    // Send request to backend to perform web scraping
                    fetch('/api/scrape-web', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ suspect_id: selectedSuspect.id })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`Web scraping initiated for ${selectedSuspect.label}.`);
                            apiRequestCount += 1;
                            document.getElementById('api-requests').innerText = apiRequestCount;
                        } else {
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while initiating web scraping.');
                    });
                } else {
                    alert('Please select a suspect to perform web scraping.');
                }
            });
    
            // API Integration Tool
            document.getElementById('api-integration').addEventListener('click', function() {
                if (selectedSuspect && selectedSuspect.type === 'suspect') {
                    // Send request to backend to perform API integration
                    fetch('/api/api-integration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ suspect_id: selectedSuspect.id })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`API integration initiated for ${selectedSuspect.label}.`);
                            apiRequestCount += 1;
                            document.getElementById('api-requests').innerText = apiRequestCount;
                        } else {
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while initiating API integration.');
                    });
                } else {
                    alert('Please select a suspect to perform API integration.');
                }
            });
    
            // Social Media Scraping Tool
            document.getElementById('social-media-scraping').addEventListener('click', function() {
                if (selectedSuspect && selectedSuspect.type === 'suspect') {
                    // Send request to backend to perform social media scraping
                    fetch('/api/social-media-scraping', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ suspect_id: selectedSuspect.id })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`Social media scraping initiated for ${selectedSuspect.label}.`);
                            apiRequestCount += 1;
                            document.getElementById('api-requests').innerText = apiRequestCount;
                        } else {
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while initiating social media scraping.');
                    });
                } else {
                    alert('Please select a suspect to perform social media scraping.');
                }
            });
    
            // Dork Suspect Button Functionality
            document.getElementById('dork-suspect').addEventListener('click', function() {
                // Retrieve the currently selected nodes
                var selectedNodes = cy.nodes('node:selected');
                // Filter to get the selected suspect
                var selectedSuspects = selectedNodes.filter(node => node.data('type') === 'suspect');

                if (selectedSuspects.length > 0) {
                    var suspect = selectedSuspects[0].data();
                    var suspectId = suspect.id;
                    console.log('Dorking Suspect:', suspect);

                    // Open the dork modal to choose options
                    dorkModal.style.display = 'block';

                    // Proceed with dorking using suspectId
                    // Example: initiateDorking(suspectId);
                } else {
                    alert('Please select a suspect to continue.');
                }
            });
    
            // Handle context menu delete via selection
            // Already handled in context menu
    
            // Profile icon functionality
            var profileIcon = document.getElementById('profile-icon');
            var accountModal = document.getElementById('account-modal');
            var logoutButtonModal = document.getElementById('logout-button-modal');
    
            profileIcon.addEventListener('click', function() {
                accountModal.style.display = 'block';
            });
    
            logoutButtonModal.addEventListener('click', function() {
                accountModal.style.display = 'none';
                alert('Logged out successfully.');
                // Implement actual logout functionality here
            });
    
            // Close modals when clicking outside of the content
            window.onclick = function(event) {
                if (event.target == addModal) {
                    addModal.style.display = 'none';
                    form.reset();
                }
                if (event.target == detailModal) {
                    detailModal.style.display = 'none';
                }
                if (event.target == accountModal) {
                    accountModal.style.display = 'none';
                }
                if (event.target == dorkModal) {
                    dorkModal.style.display = 'none';
                    dorkForm.reset();
                }
                if (event.target == existingSuspectModal) {
                    existingSuspectModal.style.display = 'none';
                }
                if (event.target == imagePreviewModal) {
                    imagePreviewModal.style.display = 'none';
                }
                if (!contextMenu.contains(event.target)) {
                    contextMenu.style.display = 'none';
                }
            };
    
            function pollForResults(suspectId, suspectName, interval = 5000, maxAttempts = 20) {
                let attempts = 0;
                let pollingMessage = document.getElementById('polling-message');
                if (pollingMessage) {
                    pollingMessage.innerText = `Scraping in progress for ${suspectName}...`;
                    pollingMessage.style.display = 'block';
                } else {
                    console.warn('Polling message element not found.');
                }
    
                function checkResults() {
                    attempts++;
                    fetch(`/api/get-results?suspect_id=${encodeURIComponent(suspectId)}`)
                    .then(response => response.json())
                    .then(resultsData => {
                        if (resultsData.status === 'success') {
                            pollingMessage.style.display = 'none';
                            // Process the data
                            processResultsData(resultsData.data);
                            alert(`Data loaded for ${suspectName}.`);
                            // Update counts
                            document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                            document.getElementById('total-connections').innerText = cy.edges().length;
                        } else {
                            if (attempts < maxAttempts) {
                                // Try again after interval
                                setTimeout(checkResults, interval);
                            } else {
                                pollingMessage.style.display = 'none';
                                alert(`Failed to load results for ${suspectName} after multiple attempts.`);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching results:', error);
                        if (attempts < maxAttempts) {
                            // Try again after interval
                            setTimeout(checkResults, interval);
                        } else {
                            pollingMessage.style.display = 'none';
                            alert(`An error occurred while fetching results for ${suspectName}.`);
                        }
                    });
                }
    
                // Start the polling
                checkResults();
            }
    
            /**
             * Function to process results data and add to Cytoscape graph
             * Categorizes data by scraping method and website domain name
             * @param {Object} data - The categorized results data from the backend
             */
            function processResultsData(data) {
                try {
                    // Define styling based on category is handled by stylesheet

                    // Identify the main suspect node ID
                    const suspectId = selectedSuspect.id;

                    // Check if the main suspect node exists; if not, add it
                    if (cy.getElementById(suspectId).length === 0) {
                        cy.add({
                            group: 'nodes',
                            data: {
                                id: suspectId,
                                label: selectedSuspect.label,
                                type: 'suspect',
                                email: selectedSuspect.email,
                                nic: selectedSuspect.nic,
                                socialMedia: selectedSuspect.socialMedia
                            }
                        });
                    }

                    // Prepare arrays to batch add nodes and edges
                    let newNodes = [];
                    let newEdges = [];

                    // Iterate over each scraping method
                    for (let method in data) {
                        let methodItems = data[method];
                        const methodNodeId = `method-${method.toLowerCase()}`;

                        // Check if method node exists; if not, add it
                        if (cy.getElementById(methodNodeId).length === 0) {
                            newNodes.push({
                                group: 'nodes',
                                data: {
                                    id: methodNodeId,
                                    label: method.toUpperCase(),
                                    type: 'method'
                                }
                            });

                            // Connect method node to suspect node
                            newEdges.push({
                                group: 'edges',
                                data: {
                                    source: suspectId,
                                    target: methodNodeId,
                                    type: 'method-connection'
                                }
                            });
                        }

                        // Group items by domain within the method
                        let domainGroups = {};
                        methodItems.forEach(item => {
                            let domain = item.domain || 'unknown_domain';
                            if (!domainGroups[domain]) {
                                domainGroups[domain] = [];
                            }
                            domainGroups[domain].push(item);
                        });

                        // Iterate over each domain
                        for (let domain in domainGroups) {
                            let domainItems = domainGroups[domain];
                            const domainNodeId = `domain-${method.toLowerCase()}-${domain.replace(/\./g, '-')}`;

                            // Check if domain node exists; if not, add it
                            if (cy.getElementById(domainNodeId).length === 0) {
                                newNodes.push({
                                    group: 'nodes',
                                    data: {
                                        id: domainNodeId,
                                        label: domain,
                                        type: 'domain',
                                        method: method.toLowerCase()
                                    }
                                });

                                // Connect domain node to method node
                                newEdges.push({
                                    group: 'edges',
                                    data: {
                                        source: methodNodeId,
                                        target: domainNodeId,
                                        type: 'domain-connection'
                                    }
                                });
                            }

                            // Iterate over each result item under the domain
                            domainItems.forEach(item => {
                                // Generate a unique node ID
                                let nodeId = generateUniqueId();

                                // Define node label based on available data
                                let label = item.title || item.link || 'Unknown';

                                // Avoid adding duplicate nodes based on a unique attribute (e.g., link)
                                if (item.link && cy.nodes(`[data-link="${item.link}"]`).length > 0) {
                                    // Node already exists based on link
                                    return;
                                }

                                // Enrich node data with additional metadata
                                let nodeData = {
                                    id: nodeId,
                                    label: label,
                                    link: item.link || '',
                                    snippet: item.snippet || '',
                                    category: item.category || 'N/A',
                                    domain: domain,
                                    method: method.toLowerCase(),
                                    type: 'result',
                                    image_url: item.image_url || '' // For image-related categories
                                };

                                // Add node to the newNodes array
                                newNodes.push({
                                    group: 'nodes',
                                    data: nodeData
                                });

                                // Add an edge connecting this node to the domain node
                                newEdges.push({
                                    group: 'edges',
                                    data: {
                                        source: domainNodeId,
                                        target: nodeId,
                                        type: 'result-connection'
                                    }
                                });
                            });
                        }
                    }

                    // Ensure newNodes and newEdges are arrays
                    newNodes = Array.isArray(newNodes) ? newNodes : [newNodes];
                    newEdges = Array.isArray(newEdges) ? newEdges : [newEdges];

                    // Batch add nodes and edges to Cytoscape
                    cy.batch(() => {
                        cy.add(newNodes);
                        cy.add(newEdges);
                    });

                    // Apply layout after adding new elements
                    cy.layout({ name: 'cose', padding: 10, animate: true }).run();

                    // Update overall details
                    document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                    document.getElementById('total-connections').innerText = cy.edges().length;

                    console.log('Results data processed and graph updated successfully.');
                } catch (error) {
                    console.error('Error processing results data:', error);
                    alert('An error occurred while processing the results data.');
                }
            }

            /**
             * Function to generate a unique ID for nodes
             * @returns {string} - A unique identifier string
             */
            function generateUniqueId() {
                return 'node-' + Math.random().toString(36).substr(2, 9);
            }

            window.addEventListener('resize', function() {
                cy.resize();
                cy.fit();
            });
        });
        </script>
</body>
</html>